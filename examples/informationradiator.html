<!DOCTYPE html>
<html>

<head>
    <title>Information Radiator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
        crossorigin="anonymous">

    <style>
        .medium-height {height: 1000px;}
        .icon{width: 20px}
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.11/moment-timezone-with-data.min.js"></script>
</head>

<body>
    <div class="row">
		<div class="col-lg-6 text-center">
            <div class="row">
				<iframe class="col-md-12" src="http://buildradiator.com/app/#/agents/stub"></iframe>
            </div>
        </div>
        <div class="col-lg-4 text-center">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h1 id="sprint-title"></h1>
                </div>
                <div class="col-lg-12 text-center">
                    <p id="sprint-subtitle"></p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 alert alert-info">
            <div class="row">
                <div class="col-lg-12">Hasselt: <span id=time-hasselt></span> <span id="weather-hasselt"></span></div>
                <div class="col-lg-12">Maastricht: <span id=time-maastricht></span> <span id="weather-maastricht"></span></div>
                <div class="col-lg-12">Bucharest: <span id=time-bucharest></span> <span id="weather-bucharest"></span></div>
                <div class="col-lg-12">Iași: <span id=time-iasi></span> <span id="weather-iasi"></span></div>
            </div>
        </div>
    </div>
    <div class="row">
        <iframe class="col-md-6 medium-height" src="http://buildradiator.com/app/#/failed/stub"></iframe>
        <iframe class="col-md-6 medium-height" src="http://buildradiator.com/app/#/running/stub"></iframe>
    </div>

    <script>
        fillInSprintTitle();
        fillInWeather();
        setInterval(fillInWeather, 1000000);
        fillInTime();
        setInterval(fillInTime, 1000);

        function fillInWeather() {
            fetch('http://api.openweathermap.org/data/2.5/group?id=2796488,2751283,683506,675810&appid=3cad991b3f551e9622851fd8d8d91566')
                .then(response =>
                    response.json()
                        .then(jsonResponse => {
                            document.getElementById("weather-hasselt").innerHTML = '<img src="http://openweathermap.org/img/w/' + jsonResponse.list[0].weather[0].icon + '.png" class="icon" />' + calculateKelvinToCelcius(jsonResponse.list[0].main.temp) + "°C";
                            document.getElementById("weather-maastricht").innerHTML = '<img src="http://openweathermap.org/img/w/' + jsonResponse.list[1].weather[0].icon + '.png" class="icon" />' + calculateKelvinToCelcius(jsonResponse.list[1].main.temp) + "°C";
                            document.getElementById("weather-iasi").innerHTML = '<img src="http://openweathermap.org/img/w/' + jsonResponse.list[2].weather[0].icon + '.png" class="icon" />' + calculateKelvinToCelcius(jsonResponse.list[2].main.temp) + "°C";
                            document.getElementById("weather-bucharest").innerHTML = '<img src="http://openweathermap.org/img/w/' + jsonResponse.list[3].weather[0].icon + '.png" class="icon" />' + calculateKelvinToCelcius(jsonResponse.list[3].main.temp) + "°C";

                        }));

            function calculateKelvinToCelcius(kelvin) {
                return Math.round(kelvin - 273.15);
            }
        }

        function fillInTime() {
            document.getElementById("time-hasselt").innerHTML = moment().tz("Europe/Brussels").format("HH:mm");
            document.getElementById("time-maastricht").innerHTML = moment().tz("Europe/Amsterdam").format("HH:mm");
            document.getElementById("time-iasi").innerHTML = moment().tz("Europe/Bucharest").format("HH:mm");
            document.getElementById("time-bucharest").innerHTML = moment().tz("Europe/Bucharest").format("HH:mm");
        }

        function fillInSprintTitle() {
            var startDateFirstSprint = moment([2015, 3, 21]);
            var now = moment();

            document.getElementById("sprint-title").innerHTML = "Sprint " + getCurrentSprint();
            document.getElementById("sprint-subtitle").innerHTML = getDaysLeftInSprint() + (getDaysLeftInSprint() === 1 ? " day" : " days") + " left";
            function getCurrentSprint() {
                return parseInt(now.diff(startDateFirstSprint, 'weeks') / 3 + 1);
            }

            function getDaysLeftInSprint() {
                const SPRINTLENGTH = 15;

                function countWeekendDaysPassed() {
                    var weekendDays = [4, 5, 11, 12, 18, 19];
                    return [4, 5, 11, 12, 18, 19].filter(weekendDay => [...Array(countDaysPastInSprint()).keys()].includes(weekendDay)).length;
                }

                function countDaysPastInSprint() {
                    return now.diff(startDateFirstSprint, 'days') % 21;
                }

                return SPRINTLENGTH - (countDaysPastInSprint() - countWeekendDaysPassed());
            }
        }
    </script>
</body>

</html>